#! /usr/bin/env python
"""
Interprets build directory music.ly file.

Collects segments (and handles tags).

Skips segment collection when called with --skip-segment-collection.
"""
import os
import shutil
import sys

import abjad
import baca


def _check_layout_time_signatures(music_ly_file_path):
    print("Checking layout time signatures ...")
    build_directory = music_ly_file_path.parent
    layout_ly_file_path = build_directory / "layout.ly"
    if not layout_ly_file_path.is_file():
        print(f"No {layout_ly_file_path.trim()} found ...")
        return
    print(f"Found {layout_ly_file_path.trim()} ...")
    partial_score = baca.segments.get_preamble_partial_score(layout_ly_file_path)
    if partial_score:
        print(f"Found {layout_y_file_path.trim()} partial score comment ...")
        print("Aborting layout time signature check ...")
        return
    metadata_time_signatures = []
    segments_directory = build_directory / "segments"
    for segment_directory in sorted(segments_directory.glob("*")):
        time_signatures = segment_directory.get_metadatum("time_signatures")
        metadata_time_signatures.extend(time_signatures)
    if metadata_time_signatures:
        print("Found time signature metadata ...")
    layout_time_signatures = baca.segments.get_preamble_time_signatures(
        layout_ly_file_path
    )
    if layout_time_signatures == metadata_time_signatures:
        message = "Layout time signatures"
        message += f" ({len(layout_time_signatures)})"
        message += " match metadata time signatures"
        message += f" ({len(metadata_time_signatures)}) ..."
        print(message)
        return
    message = "Layout time signatures"
    message += f" ({len(layout_time_signatures)})"
    message += " do not match metadata time signatures"
    message += f" ({len(metadata_time_signatures)}) ..."
    print(message)
    print(f"Remaking {layout_ly_file_path.trim()} ...")
    layout_py = layout_ly_file_path.with_suffix(".py")
    os.system(f"make-layout-ly {layout_py}")
    layout_time_signatures = baca.segments.get_preamble_time_signatures(
        layout_ly_file_path
    )
    if layout_time_signatures == metadata_time_signatures:
        message = "Layout time signatures"
        message += f" ({len(layout_time_signatures)})"
        message += " match metadata time signatures"
        message += f" ({len(metadata_time_signatures)}) ..."
    else:
        message = "Layout time signatures"
        message += f" ({len(layout_time_signatures)})"
        message += " still do not match metadata time signatures"
        message += f" ({len(metadata_time_signatures)}) ..."
    print(message)


def _trim_illustration_ly(ly):
    assert ly.is_file()
    lines = []
    with ly.open() as file_pointer:
        found_score_context_open = False
        found_score_context_close = False
        for line in file_pointer.readlines():
            if r"\context Score" in line:
                found_score_context_open = True
            if line == "        >>\n":
                found_score_context_close = True
            if found_score_context_open:
                lines.append(line)
            if found_score_context_close:
                lines.append("\n")
                break
    if lines and lines[0].startswith("    "):
        lines = [_[8:] for _ in lines]
    if lines and lines[-1] == "\n":
        lines.pop()
    lines = "".join(lines)
    return lines


build_directory = os.getcwd()
build_directory = baca.Path(build_directory)
build_type = None
if build_directory.name.endswith("-score"):
    build_type = "score" 
if build_directory.parent.name.endswith("-parts"):
    build_type = "part"
if build_type is None:
    print("Must call script in score build directory or part build directory ...")
    sys.exit(-1)

music_ly_file_paths = list(build_directory.glob("*music.ly"))
if not music_ly_file_paths:
    print(f"Missing {music_ly_file_path.trim()} ...")
    sys.exit(-1)
else:
    assert len(music_ly_file_paths) == 1, repr(music_ly_file_paths)
    music_ly_file_path = music_ly_file_paths[0]
    assert music_ly_file_path.is_file(), repr(music_ly_file_path)
    print(f"Found {music_ly_file_path.trim()} ...")

if build_type == "score":
    _segments = build_directory / "_segments"
elif build_type == "part":
    _segments = build_directory.parent / "_segments"
else:
    raise Exception(build_type)

if "--skip-segment-collection" in sys.argv:
    print("Skipping segment collection ...")
else:
    print("Collecting segment lys ...")
    segment_lys = baca.build.collect_segment_lys_CLEAN(build_directory)
    if not segment_lys:
        print("Missing segment lys ...")
        sys.exit(1)
    if _segments.exists():
        print(f"Removing {_segments.trim()} ...")
        shutil.rmtree(str(_segments))
    print(f"Making {_segments.trim()} ...")
    _segments.mkdir()
    print(f"Writing", end=" ")
    for source_ly in segment_lys:
        text = _trim_illustration_ly(source_ly)
        segment_number = source_ly.parent.name
        target_ly = _segments / f"segment-{segment_number}.ly"
        print(f"{target_ly.name.split('-')[-1]}", end=" ")
        target_ly.write_text(text)
        source_ily = source_ly.with_suffix(".ily")
        if source_ily.is_file():
            target_ily = target_ly.with_suffix(".ily")
            print(f"{target_ily.name.split('-')[-1]}", end=" ")
            shutil.copyfile(str(source_ily), str(target_ily))
    print("...")
    #baca.build.handle_build_tags(build_directory)
    baca.build.handle_build_tags(_segments)

if build_directory.parent.name.endswith("-parts"):
    if "--skip-segment-collection" in sys.argv:
        print("Skipping tag handling ...")
    else:
        os.system("handle-part-tags")

_check_layout_time_signatures(music_ly_file_path)
baca.build.run_lilypond(music_ly_file_path)

if _segments.is_dir():
    print(f"Removing {_segments.trim()} ...")
    shutil.rmtree(str(_segments))
